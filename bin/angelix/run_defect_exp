#!/bin/bash

usage() {
    cat << EOF
Usage: $0 [-h] [-f] [-d seconds] tool program revision iterations [repair_args]
EOF
}

fail() {
    touch "$defect_dir"/"$tool"_exp_fail
}

ignore_finished=true
delay=0
while getopts "d:fh" opt; do
    case $opt in
        f)
            ignore_finished=false
            ;;
        d)
            delay=$OPTARG
            ;;
        h)
            usage
            exit 0
            ;;
        *)
            usage
            exit 1
    esac
done
shift $((OPTIND-1))
[ $# -lt 5 ] && usage && exit 1

set -euxo pipefail

tool="$1"
program="$2"
repo="$3"
revision="$4"
iterations="$5"
shift 5
repair_args="$@"

if [ "$tool" != "angelix" -a "$tool" != "evangelix" ]; then
    echo "invalid tool: $tool" >&2
    exit 1
fi

script_dir=$(readlink -f $(dirname $0))
program_bin_dir=$(readlink -f "$program"/angelix-bin)
defect_dir=$(readlink -f "$program"/"$repo"/"$revision")

if [[ "$ignore_finished" = "true" && (-f "$defect_dir"/"$tool"_exp_ok || -f "$defect_dir"/"$tool"_exp_fail) ]]; then
    echo "experiment is already finished for this defect" >&2
    exit 2
fi

if [ -f "$defect_dir"/setup_buggy_fail ]; then
    echo "can't setup buggy for the experiment" >&2
    fail
    exit 1
fi

trap fail ERR

cd "$defect_dir"

rm -f "$tool"_exp_ok "$tool"_exp_fail "$tool"_exp.log

(
if [ ! -d src ]; then
    $script_dir/setup_buggy "$program".c
fi

repairs="repair_bb repair_all"

tool_results_dir=results/"$tool"
rm -rf "$tool_results_dir"

for repair in $repairs; do
    for ((i = 1; i <= $iterations; i++)); do
        sleep $delay

        rm -rf .angelix
        rm -f *.patch*

        "$program_bin_dir"/"$repair" $repair_args

        repair_results_dir="$tool_results_dir"/"$repair"/"$i"
        mkdir -p "$repair_results_dir"
        mv .angelix "$repair_results_dir"

        patch=$(ls *.patch* || true)
        if [ -n "$patch" ]; then
            mv "$patch" "$repair_results_dir"
            cp -r src "$repair_results_dir"
            cd "$repair_results_dir"/src
            patch < ../"$patch"
            make
            python3 "$script_dir"/run_tests.py "$program_bin_dir" > ../test_result.json
            cd "$defect_dir"
        fi
    done
done

touch "$tool"_exp_ok
) 2>&1 | tee "$tool"_exp.log
