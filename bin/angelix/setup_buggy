#!/bin/bash

set -euo pipefail

[ $# -ne 1 ] && echo "Usage: $0 buggy" && exit 1

buggy=$1
buggy_bn=$(basename $buggy)
prog=${buggy_bn%.c}
src_dir=$(dirname $buggy)/src
script_dir=$(readlink -f $(dirname $0))
prog_bin_dir=../../angelix-bin

mkdir -p $src_dir

cat > $src_dir/Makefile <<EOF
CC=gcc
CFLAGS=-I.

all:
	\$(CC) \$(CFLAGS) -c $prog.c -o $prog.o
	\$(CC) $prog.o -o $prog
EOF

sed -f $prog_bin_dir/instrument_buggy.sed $buggy > $src_dir/$buggy_bn

# Check if the setup is working
make -C $src_dir
cd $src_dir
python3 $script_dir/run_tests.py ../../../angelix-bin > test_result.json
python3 $script_dir/check_test_result.py test_result.json ../metadata.json
echo "SUCCESS"
